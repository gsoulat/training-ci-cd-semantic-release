# Synchronise develop avec main apr√®s chaque release
# R√©sout les conflits automatiques sur CHANGELOG.md et pyproject.toml
name: Sync Main to Develop

on:
  # Se d√©clenche apr√®s chaque workflow Release r√©ussi
  workflow_run:
    workflows: ["Release"]
    types: [completed]
    branches:
      - main

# Permissions n√©cessaires
permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Sync main to develop
    runs-on: ubuntu-latest
    # Uniquement si le workflow Release a r√©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # G√©n√®re un token avec plus de permissions (pour d√©clencher d'autres workflows)
      - name: Generate App Token
        id: get_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v5.0.0
        with:
          token: ${{ steps.get_token.outputs.token }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "super-chery-bot[bot]"
          git config user.email "super-chery-bot[bot]@users.noreply.github.com"

      - name: Sync main into develop
        run: |
          # R√©cup√®re les derni√®res modifications
          git fetch origin main
          git fetch origin develop

          # Checkout develop
          git checkout develop
          git pull origin develop

          # Merge main dans develop
          # L'option -X theirs privil√©gie main en cas de conflit sur CHANGELOG/pyproject
          if git merge origin/main --no-edit -m "chore: sync main to develop after release

          Auto-sync apr√®s release pour int√©grer les changements de semantic-release (CHANGELOG.md, pyproject.toml)"; then
            echo "‚úÖ Merge r√©ussi sans conflit"
          else
            echo "‚ö†Ô∏è Conflits d√©tect√©s, r√©solution automatique..."

            # En cas de conflit, privil√©gier la version de main pour ces fichiers
            git checkout --theirs CHANGELOG.md pyproject.toml
            git add CHANGELOG.md pyproject.toml

            # V√©rifier s'il y a d'autres conflits
            if git diff --name-only --diff-filter=U | grep -v -E '(CHANGELOG.md|pyproject.toml)'; then
              echo "‚ùå D'autres conflits existent, impossible de r√©soudre automatiquement"
              exit 1
            fi

            git commit --no-edit
            echo "‚úÖ Conflits r√©solus automatiquement"
          fi

          # Pousser develop
          git push origin develop

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ develop synchronis√© avec main avec succ√®s"
          echo "üìù CHANGELOG.md et pyproject.toml mis √† jour"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå La synchronisation automatique a √©chou√©"
          echo "üí° Synchronisation manuelle n√©cessaire :"
          echo "   git checkout develop"
          echo "   git pull origin main"
          echo "   # R√©soudre les conflits manuellement"
          echo "   git push origin develop"
