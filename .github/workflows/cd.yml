# Nom du workflow qui appara√Æt dans l'interface GitHub Actions
name: CD

# D√©finit quand ce workflow doit s'ex√©cuter
on:
  # D√©clenchement manuel depuis l'interface GitHub Actions
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement cible (dev, staging, production)'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - develop
      version:
        description: 'Version √† d√©ployer (ex: v1.2.3) - laisser vide pour latest'
        required: false
        type: string

  # D√©clenchement automatique apr√®s le workflow Release
  workflow_run:
    workflows: ["Release"]    # Nom du workflow qui doit se terminer
    types: [completed]        # D√©clenche uniquement si le workflow se termine
    branches:
      - main                  # D√©ploie automatiquement depuis main (production)


# Permissions pour ce workflow
permissions:
  contents: read      # Lecture du contenu du repository
  id-token: write     # N√©cessaire si vous utilisez OIDC

# D√©finit les diff√©rentes t√¢ches (jobs) √† ex√©cuter
jobs:
  # Job pour d√©ployer l'application sur Azure
  deploy:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest    # Utilise la derni√®re version d'Ubuntu
    # Emp√™che plusieurs d√©ploiements simultan√©s sur le m√™me environnement
    concurrency:
      group: deploy-${{ github.event.inputs.environment || ((github.event.workflow_run.head_branch || github.ref_name) == 'main' && 'production' || 'staging') }}
      
    # Ne d√©ploie que si le workflow Release a r√©ussi ou si c'est un d√©clenchement manuel
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    # D√©termine l'environnement en fonction du contexte
    environment:
      name: ${{ github.event.inputs.environment || ((github.event.workflow_run.head_branch || github.ref_name) == 'main' && 'production' || 'staging') }}
      url: ${{ steps.deploy.outputs.url }}  # URL de l'application d√©ploy√©e
    # Outputs permettent de partager des donn√©es avec d'autres jobs
    outputs:
      url: ${{ steps.deploy.outputs.url }}  # Expose l'URL pour les jobs suivants (health-check)
      version: ${{ steps.version.outputs.version }}  # Expose la version d√©ploy√©e

    steps:
      # √âtape 1: R√©cup√®re le code source (n√©cessaire pour les configs)
      - name: Checkout
        uses: actions/checkout@v5.0.0

      # √âtape 2: D√©termine la version √† d√©ployer
      - name: Determine Version
        id: version
        run: |
          # Si une version est sp√©cifi√©e manuellement, on l'utilise
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Pour les d√©ploiements automatiques, r√©cup√®re le dernier tag cr√©√© par Release
            git fetch --tags
            VERSION=$(git describe --tags --abbrev=0)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Deploying version: $VERSION"

      # √âtape 3: Authentification √† Azure via Service Principal
      - name: Azure Login
        uses: azure/login@v1  # Action officielle Microsoft Azure
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}  # JSON du Service Principal

          # ALTERNATIVE avec OIDC (plus s√©curis√©, d√©commentez si configur√©):
          # client-id: ${{ secrets.AZURE_CLIENT_ID }}
          # tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          # subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # √âtape 4: D√©ploie l'application sur Azure Container Apps
      - name: Deploy to Azure Container Apps
        id: deploy
        uses: azure/container-apps-deploy-action@v1  # Action Azure pour Container Apps
        with:
          # Nom de la Container App Azure
          containerAppName: ${{ secrets.AZURE_CONTAINER_APP_NAME }}
          # Resource Group o√π se trouve la Container App
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
          # Image Docker √† d√©ployer depuis GitHub Container Registry
          imageToDeploy: ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}

      # √âtape 5: Affiche l'URL de d√©ploiement
      - name: Display Deployment URL
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåê Application URL: ${{ steps.deploy.outputs.url }}"
          echo "üì¶ Version deployed: ${{ steps.version.outputs.version }}"
          echo "üéØ Environment: ${{ github.event.inputs.environment || ((github.event.workflow_run.head_branch || github.ref_name) == 'main' && 'production' || 'staging') }}"

  # Job pour v√©rifier la sant√© de l'application apr√®s d√©ploiement
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy              # Ce job attend que le d√©ploiement soit termin√©
    steps:
      # √âtape 1: Attend que l'application soit pr√™te
      - name: Wait for Application
        run: |
          echo "‚è≥ Waiting 30 seconds for application to be ready..."
          sleep 30

      # √âtape 2: V√©rifie que l'application r√©pond (endpoint de sant√©)
      - name: Health Check
        run: |
          # TODO: Personnalisez cette √©tape selon votre application
          # Exemple avec un endpoint /health
          # URL="${{ needs.deploy.outputs.url }}"
          # RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$URL/health")
          # if [ "$RESPONSE" -eq 200 ]; then
          #   echo "‚úÖ Health check passed!"
          # else
          #   echo "‚ùå Health check failed with status: $RESPONSE"
          #   exit 1
          # fi

          echo "‚ö†Ô∏è Health check not implemented yet"
          echo "üëâ Implement a health check endpoint in your application"

  # Job optionnel: Rollback en cas de probl√®me
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: failure()              # S'ex√©cute uniquement si un job pr√©c√©dent √©choue
    steps:
      - name: Notify Rollback Needed
        run: |
          echo "‚ùå Deployment or health check failed!"
          echo "üîÑ Manual rollback may be needed"
          echo "üí° Run this workflow manually with the previous working version"

